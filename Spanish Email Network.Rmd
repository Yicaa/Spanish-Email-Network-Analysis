---
title: "Spanish Email Network"
author: "Yijia Lin, Bradley McKenzie and Diego Paroli"
date: "`r Sys.Date()`"
output: html_document
---

# Libraries

```{r, message=FALSE, warning=FALSE}
rm(list = ls())
library(tidyverse)
library(httr2)
library(igraph)
library(visNetwork)
library(tidygraph)
library(ggraph)
library(here)
```

# Get the data

```{r, message=FALSE, warning=FALSE}
nodes <- read_csv(here("network_data", "nodes.csv"))
links <- read_csv(here("network_data", "edges.csv"))
```

# Description of the dataset

This network is a directed and unweighted social communication network, which represents the exchange of emails among members of the Rovira i Virgili University in Spain, in 2003.

Source: [Netzschleuder](https://networks.skewed.de/net/uni_email).

### Properties

Directed, unweighted, social communication network.

### Nodes and links

```{r}
head(nodes)
head(links)
```

Within the `nodes` dataframe, the column `# index` is the one indicating the index of the nodes,
the column `name` is the one indicating their corresponding name (although already anonymised), and the `_pos` column represents the coordinates of each node in a 2D space, typically used for visualization or layout in graph-related tasks. In the `links` dataframe, the column `# source` and `target` indicate the 2
nodes forming a link

### Graph:

```{r}
graph <- graph_from_data_frame(links, directed = TRUE, vertices = nodes)
graph
```

# Questions

## 1) Delete a fraction of real edges in the network and create a table of those links deleted (positive class) and of links non-present (negative class)

```{r}
# Set seed for reproducibility
set.seed(123)

# Randomly delete some real edges: set as positive class
edge_list <- as_data_frame(graph, what = "edges")
n_edges <- nrow(edge_list)
n_remove <- floor(0.1 * n_edges) #We will delete 10% of the real edges
removed_edges <- edge_list[sample(1:n_edges, n_remove), ]
graph_modified <- delete_edges(graph, E(graph)[from = removed_edges$from, to = removed_edges$to])

# Label the deleted real edges as positive class (1)
positive_edges <- removed_edges %>%
  mutate(label = 1)
```

```{r}
# Create a new data frame to register the negative class (made-up links)
false_edges <- data.frame()
# Filter the most connected nodes to create non-existent links 
#that are less obviously disconnected, which is better for machine learning
most_connected <- which(degree(graph)>10)
# Set seed again just in case
set.seed(123)

# Create a loop for creating made-up links, registering all in `false_edges`
while (nrow(false_edges) < n_remove) {
  node1 <- sample(most_connected, 1)
  node2 <- sample(most_connected, 1)
  
  # avoid self-connecting
  if (node1 == node2) next
  
  # Check if two nodes are connected, if not, create a negative link for them
  if (!are.connected(graph, node1, node2)) {
    edge_row <- data.frame(from = as_ids(V(graph)[node1]), 
                           to = as_ids(V(graph)[node2]),
                           label = 0)
    
    # avoid adding same links
    if (!any(apply(false_edges, 1, function(row) all(row == edge_row)))) {
      false_edges <- rbind(false_edges, edge_row)
    }
  }
}

```

```{r}
# Uniform the format of tables before binding
positive_edges <- positive_edges %>%
  mutate(from = as.character(from), to = as.character(to))

false_edges <- false_edges %>%
  mutate(from = as.character(from), to = as.character(to))

# Bind the positive and negative edges
all_edges <- bind_rows(positive_edges, false_edges)
head(all_edges)
table(all_edges$label)
```


## 2) Generate a number of proximity/similarty metrics heuristics for each link in the positive and negative class

```{r}

```

## 3) Train a binary classifier to predict the links, i.e., to predict the class (positive/negative) using those heuristics. Use crossvalidation.

```{r}

```

## 4) Evaluate the precision of the model. Which heuristic is the most important. Why do you think it is the most important?

```{r}

```

## 5) Comment on potential ways to improve the link prediction

```{r}

```

